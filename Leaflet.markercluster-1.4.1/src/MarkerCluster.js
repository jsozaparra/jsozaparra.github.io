export var MarkerCluster=L.MarkerCluster=L.Marker.extend({options:L.Icon.prototype.options,initialize:function(t,e,s,i){L.Marker.prototype.initialize.call(this,s?s._cLatLng||s.getLatLng():new L.LatLng(0,0),{icon:this,pane:t.options.clusterPane}),this._group=t,this._zoom=e,this._markers=[],this._childClusters=[],this._childCount=0,this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._bounds=new L.LatLngBounds,s&&this._addChild(s),i&&this._addChild(i)},getAllChildMarkers:function(t,e){t=t||[];for(var s=this._childClusters.length-1;s>=0;s--)this._childClusters[s].getAllChildMarkers(t);for(var i=this._markers.length-1;i>=0;i--)e&&this._markers[i].__dragStart||t.push(this._markers[i]);return t},getChildCount:function(){return this._childCount},zoomToBounds:function(t){for(var e,s=this._childClusters.slice(),i=this._group._map,n=i.getBoundsZoom(this._bounds),r=this._zoom+1,o=i.getZoom();s.length>0&&n>r;){r++;var _=[];for(e=0;e<s.length;e++)_=_.concat(s[e]._childClusters);s=_}n>r?this._group._map.setView(this._latlng,r):n<=o?this._group._map.setView(this._latlng,o+1):this._group._map.fitBounds(this._bounds,t)},getBounds:function(){var t=new L.LatLngBounds;return t.extend(this._bounds),t},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(t,e){this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._setClusterCenter(t),t instanceof L.MarkerCluster?(e||(this._childClusters.push(t),t.__parent=this),this._childCount+=t._childCount):(e||this._markers.push(t),this._childCount++),this.__parent&&this.__parent._addChild(t,!0)},_setClusterCenter:function(t){this._cLatLng||(this._cLatLng=t._cLatLng||t._latlng)},_resetBounds:function(){var t=this._bounds;t._southWest&&(t._southWest.lat=Infinity,t._southWest.lng=Infinity),t._northEast&&(t._northEast.lat=-Infinity,t._northEast.lng=-Infinity)},_recalculateBounds:function(){var t,e,s,i,n=this._markers,r=this._childClusters,o=0,_=0,h=this._childCount;if(0!==h){for(this._resetBounds(),t=0;t<n.length;t++)s=n[t]._latlng,this._bounds.extend(s),o+=s.lat,_+=s.lng;for(t=0;t<r.length;t++)(e=r[t])._boundsNeedUpdate&&e._recalculateBounds(),this._bounds.extend(e._bounds),s=e._wLatLng,i=e._childCount,o+=s.lat*i,_+=s.lng*i;this._latlng=this._wLatLng=new L.LatLng(o/h,_/h),this._boundsNeedUpdate=!1}},_addToMap:function(t){t&&(this._backupLatlng=this._latlng,this.setLatLng(t)),this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(t,e,s){this._recursively(t,this._group._map.getMinZoom(),s-1,function(t){var s,i,n=t._markers;for(s=n.length-1;s>=0;s--)(i=n[s])._icon&&(i._setPos(e),i.clusterHide())},function(t){var s,i,n=t._childClusters;for(s=n.length-1;s>=0;s--)(i=n[s])._icon&&(i._setPos(e),i.clusterHide())})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(t,e,s,i){this._recursively(t,i,e,function(n){n._recursivelyAnimateChildrenIn(t,n._group._map.latLngToLayerPoint(n.getLatLng()).round(),s),n._isSingleParent()&&s-1===i?(n.clusterShow(),n._recursivelyRemoveChildrenFromMap(t,e,s)):n.clusterHide(),n._addToMap()})},_recursivelyBecomeVisible:function(t,e){this._recursively(t,this._group._map.getMinZoom(),e,null,function(t){t.clusterShow()})},_recursivelyAddChildrenToMap:function(t,e,s){this._recursively(s,this._group._map.getMinZoom()-1,e,function(i){if(e!==i._zoom)for(var n=i._markers.length-1;n>=0;n--){var r=i._markers[n];s.contains(r._latlng)&&(t&&(r._backupLatlng=r.getLatLng(),r.setLatLng(t),r.clusterHide&&r.clusterHide()),i._group._featureGroup.addLayer(r))}},function(e){e._addToMap(t)})},_recursivelyRestoreChildPositions:function(t){for(var e=this._markers.length-1;e>=0;e--){var s=this._markers[e];s._backupLatlng&&(s.setLatLng(s._backupLatlng),delete s._backupLatlng)}if(t-1===this._zoom)for(var i=this._childClusters.length-1;i>=0;i--)this._childClusters[i]._restorePosition();else for(var n=this._childClusters.length-1;n>=0;n--)this._childClusters[n]._recursivelyRestoreChildPositions(t)},_restorePosition:function(){this._backupLatlng&&(this.setLatLng(this._backupLatlng),delete this._backupLatlng)},_recursivelyRemoveChildrenFromMap:function(t,e,s,i){var n,r;this._recursively(t,e-1,s-1,function(t){for(r=t._markers.length-1;r>=0;r--)n=t._markers[r],i&&i.contains(n._latlng)||(t._group._featureGroup.removeLayer(n),n.clusterShow&&n.clusterShow())},function(t){for(r=t._childClusters.length-1;r>=0;r--)n=t._childClusters[r],i&&i.contains(n._latlng)||(t._group._featureGroup.removeLayer(n),n.clusterShow&&n.clusterShow())})},_recursively:function(t,e,s,i,n){var r,o,_=this._childClusters,h=this._zoom;if(e<=h&&(i&&i(this),n&&h===s&&n(this)),h<e||h<s)for(r=_.length-1;r>=0;r--)(o=_[r])._boundsNeedUpdate&&o._recalculateBounds(),t.intersects(o._bounds)&&o._recursively(t,e,s,i,n)},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}});